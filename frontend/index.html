<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DailyTrackr - Your Productivity Companion</title>
    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2rem;
            color: #667eea;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #667eea;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        }

        .btn-confirm-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        /* Cards and Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background-color: #f8f9fa;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Lists (Activities & Habits) */
        .activity-item, .habit-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .habit-item {
            border-left-color: #4ecdc4;
        }

        .activity-item:hover, .habit-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-thumbnail {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            background-color: #e9ecef;
        }

        .item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-note {
            margin-top: 8px;
            color: #666;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .habit-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .habit-progress-fill {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }

        /* Image Preview */
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px dashed #ddd;
            padding: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #667eea;
        }

        /* AI Insights */
        .ai-insight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #333;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #667eea;
        }

        .ai-insight h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 3.7s forwards;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification.success { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .notification.error { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading.dark {
            border-color: rgba(0,0,0,0.1);
            border-top-color: #667eea;
        }

        /* Chart */
        .chart-container {
            height: 200px;
            display: flex;
            align-items: end;
            justify-content: space-around;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }
        .chart-bar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 30px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
        }
        .chart-bar:hover {
            transform: scaleY(1.05);
            opacity: 0.8;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .auth-title {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        /* Utility */
        .hidden { display: none !important; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; }
            .container { padding: 10px; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
<div id="auth-screen" class="auth-container">
    <div class="auth-card">
        <h2 class="auth-title">🧠 DailyTrackr</h2>
        <div id="auth-tabs" class="tabs">
            <button class="tab active" onclick="switchAuthTab(event, 'login')">Login</button>
            <button class="tab" onclick="switchAuthTab(event, 'register')">Register</button>
        </div>

        <div id="login-form" class="tab-content active">
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" value="testuser@example.com" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" value="password123" placeholder="Enter your password">
            </div>
            <button class="btn" onclick="login()" style="width: 100%">
                <span id="login-loading" class="loading hidden"></span>
                <span>Login</span>
            </button>
        </div>

        <div id="register-form" class="tab-content">
            <div class="form-group">
                <label for="register-username">Username:</label>
                <input type="text" id="register-username" placeholder="Choose a username">
            </div>
            <div class="form-group">
                <label for="register-email">Email:</label>
                <input type="email" id="register-email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="register-password">Password:</label>
                <input type="password" id="register-password" placeholder="Create a password">
            </div>
            <button class="btn" onclick="register()" style="width: 100%">
                <span id="register-loading" class="loading hidden"></span>
                <span>Register</span>
            </button>
        </div>
    </div>
</div>

<div id="main-app" class="container hidden">
    <div class="header">
        <div class="logo">
            <h1>🧠 DailyTrackr</h1>
            <span style="color: #666; font-size: 0.9rem;">Your Productivity Companion</span>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="user-avatar" onclick="openModal('user-modal')">U</div>
            <div>
                <div style="font-weight: 600;" id="user-name">Loading...</div>
                <div style="font-size: 0.8rem; color: #666;" id="user-email">Loading...</div>
            </div>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card stat-card"><div class="stat-number" id="total-activities">0</div><div class="stat-label">Total Activities</div></div>
        <div class="card stat-card"><div class="stat-number" id="total-hours">0.0</div><div class="stat-label">Hours Logged</div></div>
        <div class="card stat-card"><div class="stat-number" id="active-habits">0</div><div class="stat-label">Active Habits</div></div>
        <div class="card stat-card"><div class="stat-number" id="total-expenses">Rp0</div><div class="stat-label">Total Expenses</div></div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr; align-items: start;">
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'activities')">📋 Activities</button>
                <button class="tab" onclick="switchTab(event, 'habits')">🎯 Habits</button>
                <button class="tab" onclick="switchTab(event, 'statistics')">📊 Statistics</button>
            </div>
            <div id="activities-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Recent Activities</h3>
                    <button class="btn" onclick="openModal('activity-modal')">+ Add Activity</button>
                </div>
                <div id="activities-list"><p>Loading activities...</p></div>
            </div>
            <div id="habits-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>My Habits</h3>
                    <button class="btn" onclick="openModal('habit-modal')">+ Add Habit</button>
                </div>
                <div id="habits-list"><p>Loading habits...</p></div>
            </div>
            <div id="statistics-tab" class="tab-content">
                <h3>Activity Statistics (Last 7 Days)</h3>
                <div class="chart-container" id="activity-chart"></div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="loadStatistics()">Refresh Statistics</button>
                </div>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 25px;">
            <div class="card">
                <h3>🤖 AI Actions</h3>
                <div id="ai-insights-container" style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="ai-insight">
                        <h4>Daily Summary</h4>
                        <p id="daily-summary">Click 'Generate' to get your AI summary.</p>
                    </div>
                    <button class="btn" onclick="generateDailySummary()">
                        <span id="ai-summary-loading" class="loading hidden"></span>
                        <span>Generate Daily Summary</span>
                    </button>
                    <button class="btn" onclick="generateHabitRecommendation()">
                        <span id="ai-habit-loading" class="loading hidden"></span>
                        <span>Get Habit Recommendations</span>
                    </button>
                    <button class="btn" onclick="getProductivityTips()">
                        <span id="ai-tips-loading" class="loading hidden"></span>
                        <span>Get Productivity Tips</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('user-modal')">&times;</span>
        <h2>User Profile & Settings</h2>

        <div class="form-group">
            <label for="profile-username">Username:</label>
            <input type="text" id="profile-username">
        </div>
        <div class="form-group">
            <label for="profile-bio">Bio:</label>
            <textarea id="profile-bio" placeholder="Tell us about yourself..."></textarea>
        </div>
        <button class="btn" onclick="updateProfile()">Update Profile</button>
        <hr style="margin: 20px 0;">

        <h4>Change Password</h4>
        <div class="form-group">
            <label for="current-password">Current Password:</label>
            <input type="password" id="current-password" placeholder="Your current password">
        </div>
        <div class="form-group">
            <label for="new-password">New Password:</label>
            <input type="password" id="new-password" placeholder="Your new password">
        </div>
        <button class="btn" onclick="changePassword()">Change Password</button>
        <hr style="margin: 20px 0;">

        <h4>Profile Photo</h4>
        <div class="form-group">
            <label for="profile-photo-upload">Upload new photo:</label>
            <input type="file" id="profile-photo-upload" accept="image/jpeg,image/png,image/webp" onchange="previewImage(event, 'profile-photo-preview')">
            <img id="profile-photo-preview" class="image-preview hidden" alt="Profile photo preview">
        </div>
        <button class="btn" onclick="uploadProfilePhoto()">Upload Photo</button>
    </div>
</div>


<div id="activity-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('activity-modal')">&times;</span>
        <h2 id="activity-modal-title">Add New Activity</h2>
        <input type="hidden" id="activity-id">
        <div class="form-group"><label for="modal-activity-title">Title:</label><input type="text" id="modal-activity-title" placeholder="What did you do?"></div>
        <div class="form-group"><label for="modal-activity-start-time">Start Time:</label><input type="datetime-local" id="modal-activity-start-time"></div>
        <div class="form-group"><label for="modal-activity-duration">Duration (minutes):</label><input type="number" id="modal-activity-duration" placeholder="60"></div>
        <div class="form-group"><label for="modal-activity-cost">Cost (optional):</label><input type="number" id="modal-activity-cost" placeholder="0"></div>
        <div class="form-group"><label for="modal-activity-note">Notes:</label><textarea id="modal-activity-note" placeholder="Additional notes..."></textarea></div>
        <button class="btn" onclick="saveActivity()">
            <span id="save-activity-loading" class="loading hidden"></span>
            <span id="save-activity-button-text">Create Activity</span>
        </button>
    </div>
</div>

<div id="activity-photo-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('activity-photo-modal')">&times;</span>
        <h2>Upload Photo for Activity</h2>
        <input type="hidden" id="photo-activity-id">
        <div class="form-group">
            <label for="activity-photo-upload">Select photo:</label>
            <input type="file" id="activity-photo-upload" accept="image/jpeg,image/png,image/webp,image/gif" onchange="previewImage(event, 'activity-photo-preview')">
            <img id="activity-photo-preview" class="image-preview hidden" alt="Activity photo preview">
        </div>
        <button class="btn" onclick="uploadActivityPhoto()">
            <span id="upload-activity-photo-loading" class="loading hidden"></span>
            <span>Upload</span>
        </button>
    </div>
</div>

<div id="habit-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('habit-modal')">&times;</span>
        <h2 id="habit-modal-title">Create New Habit</h2>
        <input type="hidden" id="habit-id">
        <div class="form-group"><label for="modal-habit-title">Habit Title:</label><input type="text" id="modal-habit-title" placeholder="What habit do you want to build?"></div>
        <div class="form-group"><label for="modal-habit-start-date">Start Date:</label><input type="date" id="modal-habit-start-date"></div>
        <div class="form-group"><label for="modal-habit-end-date">End Date:</label><input type="date" id="modal-habit-end-date"></div>
        <div class="form-group"><label for="modal-habit-reminder-time">Reminder Time:</label><input type="time" id="modal-habit-reminder-time" value="09:00"></div>
        <button class="btn" onclick="saveHabit()">
            <span id="save-habit-loading" class="loading hidden"></span>
            <span id="save-habit-button-text">Create Habit</span>
        </button>
    </div>
</div>

<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('confirm-modal')">&times;</span>
        <h2 id="confirm-title">Are you sure?</h2>
        <p id="confirm-message" style="margin: 20px 0;"></p>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button>
            <button id="confirm-button" class="btn btn-danger">Confirm</button>
        </div>
    </div>
</div>


<script>
    // --- CONFIGURATION ---
    const API_BASE = 'http://localhost:3000'; // Gateway URL
    let currentToken = null;
    let currentUser = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        setDefaultDates();
        generateMockChart(); // Initial chart display
    });

    // --- AUTHENTICATION ---
    function checkAuth() {
        const token = localStorage.getItem('jwt_token');
        const user = localStorage.getItem('current_user');
        if (token && user) {
            currentToken = token;
            currentUser = JSON.parse(user);
            showMainApp();
            updateUserInfoUI();
            loadDashboard();
        } else {
            showAuthScreen();
        }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) return showNotification('Please fill in all fields', 'error');

        showLoading('login-loading');
        try {
            const response = await apiRequest('/api/users/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (response.ok) {
                currentToken = data.data.token;
                currentUser = data.data.user;
                localStorage.setItem('jwt_token', currentToken);
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                showNotification('Login successful!', 'success');
                showMainApp();
                updateUserInfoUI();
                loadDashboard();
            } else {
                showNotification(data.message || 'Login failed', 'error');
            }
        } catch (error) {
            showNotification('Network error. Please try again.', 'error');
        } finally {
            hideLoading('login-loading');
        }
    }

    async function register() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        if (!username || !email || !password) return showNotification('Please fill in all fields', 'error');

        showLoading('register-loading');
        try {
            const response = await apiRequest('/api/users/auth/register', {
                method: 'POST',
                body: JSON.stringify({ username, email, password })
            });
            const data = await response.json();
            if (response.ok) {
                showNotification('Registration successful! Please login.', 'success');
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = '';
                switchAuthTab(null, 'login', true);
            } else {
                showNotification(data.message || 'Registration failed', 'error');
            }
        } catch (error) {
            showNotification('Network error. Please try again.', 'error');
        } finally {
            hideLoading('register-loading');
        }
    }

    function logout() {
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('current_user');
        currentToken = null;
        currentUser = null;
        showAuthScreen();
        showNotification('Logged out successfully', 'success');
    }

    // --- API HELPERS ---
    async function apiRequest(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }

        if (options.body instanceof FormData) {
            delete headers['Content-Type'];
        }

        const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
        return response;
    }

    // --- DATA LOADING & RENDERING ---
    function updateUserInfoUI() {
        if (!currentUser) return;
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-email').textContent = currentUser.email;

        const avatar = document.getElementById('user-avatar');
        avatar.style.backgroundImage = currentUser.profile_photo ? `url(${currentUser.profile_photo})` : '';
        avatar.textContent = currentUser.profile_photo ? '' : currentUser.username.charAt(0).toUpperCase();

        document.getElementById('profile-username').value = currentUser.username;
        document.getElementById('profile-bio').value = currentUser.bio || '';
    }

    async function loadDashboard() {
        try {
            const response = await apiRequest('/api/stats/api/v1/stats/dashboard');
            if (response.ok) {
                const data = await response.json();
                const stats = data.data;
                document.getElementById('total-activities').textContent = stats.total_activities || 0;
                document.getElementById('total-hours').textContent = (stats.total_hours || 0).toFixed(1);
                document.getElementById('active-habits').textContent = stats.active_habits || 0;
                document.getElementById('total-expenses').textContent = `Rp${(stats.total_expenses || 0).toLocaleString()}`;
            }
        } catch (error) {
            console.error('Failed to load dashboard:', error);
        }
        loadActivities();
        loadHabits();
    }

    async function loadActivities() {
        try {
            const response = await apiRequest('/api/activities/api/v1/activities/');
            if (response.ok) {
                const data = await response.json();
                const activities = data.data.activities || [];
                const list = document.getElementById('activities-list');
                if(activities.length === 0) {
                    list.innerHTML = '<p>No activities found. Create your first activity!</p>';
                    return;
                }
                const activitiesHTML = activities.map(act => `
                        <div class="activity-item">
                             <div class="item-header">
                                ${act.photo_url ? `<div class="item-thumbnail" style="background-image: url(${act.photo_url})"></div>` : '<div class="item-thumbnail"></div>'}
                                <div class="item-title">${act.title}</div>
                            </div>
                            <div class="item-meta">
                                <span>${new Date(act.start_time).toLocaleDateString()} - ${act.duration_mins} mins</span>
                                <div class="item-actions">
                                    ${act.cost ? `<span>Rp${act.cost.toLocaleString()}</span>` : ''}
                                    <button class="btn btn-small" onclick="openPhotoUploadModal(${act.id})">📷 Photo</button>
                                    <button class="btn btn-small" onclick="editActivity(${act.id})">Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="confirmDelete('activity', ${act.id})">Delete</button>
                                </div>
                            </div>
                            ${act.note ? `<div class="item-note">${act.note}</div>` : ''}
                        </div>`).join('');
                list.innerHTML = activitiesHTML;
            }
        } catch (error) {
            console.error('Failed to load activities:', error);
            document.getElementById('activities-list').innerHTML = '<p>Could not load activities.</p>';
        }
    }

    async function loadHabits() {
        try {
            // CORRECTED: Switched from failing stats endpoint to the direct habit endpoint
            const response = await apiRequest('/api/habits/api/v1/habits');
            if (response.ok) {
                const data = await response.json();
                const habits = data.data || [];
                const list = document.getElementById('habits-list');
                if(habits.length === 0) {
                    list.innerHTML = '<p>No habits found. Create your first habit!</p>';
                    return;
                }
                const habitsHTML = habits.map(habit => {
                    return `
                        <div class="habit-item">
                            <div class="item-title">${habit.title}</div>
                            <div class="item-meta">
                                <span>${new Date(habit.start_date).toLocaleDateString()} to ${new Date(habit.end_date).toLocaleDateString()}</span>
                                <div class="item-actions">
                                    <button class="btn btn-small btn-success" onclick="logHabit(${habit.id})">Log Today</button>
                                    <button class="btn btn-small" onclick="editHabit(${habit.id})">Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="confirmDelete('habit', ${habit.id})">Delete</button>
                                </div>
                            </div>
                        </div>`;
                }).join('');
                list.innerHTML = habitsHTML;
            }
        } catch (error) {
            console.error('Failed to load habits:', error);
            document.getElementById('habits-list').innerHTML = '<p>Could not load habits.</p>';
        }
    }

    async function loadStatistics() {
        try {
            const response = await apiRequest('/api/stats/api/v1/stats/activities/chart?type=daily&period=7');
            if (response.ok) {
                const data = await response.json();
                generateChart(data.data.data || []);
            } else {
                generateMockChart();
            }
        } catch (error) {
            generateMockChart();
        }
    }

    // --- AI FUNCTIONS ---
    async function generateDailySummary() {
        showLoading('ai-summary-loading');
        const summaryEl = document.getElementById('daily-summary');
        try {
            const response = await apiRequest('/api/ai/api/v1/ai/daily-summary', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                summaryEl.textContent = data.data.summary_text || 'No insights available yet.';
            } else {
                summaryEl.textContent = data.message || 'Could not generate summary.';
            }
        } catch (error) {
            summaryEl.textContent = 'AI service temporarily unavailable.';
        } finally {
            hideLoading('ai-summary-loading');
        }
    }

    async function generateHabitRecommendation() {
        showLoading('ai-habit-loading');
        try {
            const response = await apiRequest('/api/ai/api/v1/ai/habit-recommendation', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                showNotification('Habit Recommendation: ' + data.data.recommendation, 'success');
            } else {
                showNotification(data.message || 'Could not get recommendations', 'error');
            }
        } catch(e) {
            showNotification('AI service is temporarily unavailable.', 'error');
        } finally {
            hideLoading('ai-habit-loading');
        }
    }

    async function getProductivityTips() {
        showLoading('ai-tips-loading');
        try {
            const response = await apiRequest('/api/ai/api/v1/ai/productivity-tips');
            const data = await response.json();
            if (response.ok) {
                showNotification('Productivity Tip: ' + data.data.tips, 'success');
            } else {
                showNotification(data.message || 'Could not get tips', 'error');
            }
        } catch(e) {
            showNotification('AI service is temporarily unavailable.', 'error');
        } finally {
            hideLoading('ai-tips-loading');
        }
    }


    // --- CRUD & ACTIONS ---

    // Profile
    async function updateProfile() {
        const profileData = {
            username: document.getElementById('profile-username').value,
            bio: document.getElementById('profile-bio').value,
        };
        try {
            const response = await apiRequest('/api/users/api/v1/users/profile', { method: 'PUT', body: JSON.stringify(profileData) });
            const data = await response.json();
            if (response.ok) {
                showNotification('Profile updated!', 'success');
                currentUser = data.data;
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                updateUserInfoUI();
                closeModal('user-modal');
            } else {
                showNotification(data.message || 'Failed to update profile', 'error');
            }
        } catch(e) {
            showNotification('Network error.', 'error');
        }
    }

    async function changePassword() {
        const passwordData = {
            current_password: document.getElementById('current-password').value,
            new_password: document.getElementById('new-password').value,
        };
        if (!passwordData.current_password || !passwordData.new_password) {
            return showNotification('Please fill both password fields.', 'error');
        }
        try {
            const response = await apiRequest('/api/users/api/v1/users/password', { method: 'PUT', body: JSON.stringify(passwordData) });
            if (response.ok) {
                showNotification('Password changed successfully!', 'success');
                closeModal('user-modal');
            } else {
                const data = await response.json();
                showNotification(data.message || 'Failed to change password', 'error');
            }
        } catch(e) {
            showNotification('Network error.', 'error');
        }
    }

    async function uploadProfilePhoto() {
        const fileInput = document.getElementById('profile-photo-upload');
        if (fileInput.files.length === 0) {
            return showNotification('Please select a photo to upload.', 'error');
        }
        const formData = new FormData();
        formData.append('photo', fileInput.files[0]);
        try {
            const response = await apiRequest('/api/users/api/v1/users/profile/photo', { method: 'POST', body: formData });
            if (response.ok) {
                showNotification('Photo uploaded successfully!', 'success');
                const profileResponse = await apiRequest('/api/users/api/v1/users/profile');
                const data = await profileResponse.json();
                currentUser = data.data;
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                updateUserInfoUI();
                closeModal('user-modal');
            } else {
                const data = await response.json();
                showNotification(data.message || 'Failed to upload photo.', 'error');
            }
        } catch(e) {
            showNotification('Network error.', 'error');
        }
    }


    // Activity
    async function saveActivity() {
        const id = document.getElementById('activity-id').value;
        const isEditing = id !== '';

        const activity = {
            title: document.getElementById('modal-activity-title').value,
            start_time: new Date(document.getElementById('modal-activity-start-time').value).toISOString(),
            duration_mins: parseInt(document.getElementById('modal-activity-duration').value),
            cost: parseInt(document.getElementById('modal-activity-cost').value) || null,
            note: document.getElementById('modal-activity-note').value
        };
        if (!activity.title || !activity.start_time || !activity.duration_mins) return showNotification('Please fill in required fields', 'error');

        const endpoint = isEditing ? `/api/activities/api/v1/activities/${id}` : '/api/activities/api/v1/activities/';
        const method = isEditing ? 'PUT' : 'POST';

        showLoading('save-activity-loading');
        try {
            const response = await apiRequest(endpoint, { method, body: JSON.stringify(activity) });
            if (response.ok) {
                showNotification(`Activity ${isEditing ? 'updated' : 'created'}!`, 'success');
                closeModal('activity-modal');
                loadActivities();
                loadDashboard();
            } else {
                const data = await response.json();
                showNotification(data.message || 'Failed to save activity', 'error');
            }
        } catch (error) {
            showNotification('Network error. Please try again.', 'error');
        } finally {
            hideLoading('save-activity-loading');
        }
    }

    async function editActivity(id) {
        try {
            const response = await apiRequest(`/api/activities/api/v1/activities/${id}`);
            if(response.ok) {
                const data = await response.json();
                const act = data.data;
                document.getElementById('activity-modal-title').innerText = "Edit Activity";
                document.getElementById('activity-id').value = act.id;
                document.getElementById('modal-activity-title').value = act.title;
                document.getElementById('modal-activity-start-time').value = new Date(new Date(act.start_time).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('modal-activity-duration').value = act.duration_mins;
                document.getElementById('modal-activity-cost').value = act.cost || 0;
                document.getElementById('modal-activity-note').value = act.note || '';
                document.getElementById('save-activity-button-text').innerText = "Update Activity";
                openModal('activity-modal');
            } else {
                showNotification('Could not fetch activity details.', 'error');
            }
        } catch (error) {
            showNotification('Network error.', 'error');
        }
    }

    async function deleteActivity(id) {
        try {
            const response = await apiRequest(`/api/activities/api/v1/activities/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showNotification('Activity deleted.', 'success');
                loadActivities();
                loadDashboard();
            } else {
                showNotification('Failed to delete activity', 'error');
            }
        } catch (error) {
            showNotification('Network error.', 'error');
        }
    }

    function openPhotoUploadModal(activityId) {
        document.getElementById('photo-activity-id').value = activityId;
        document.getElementById('activity-photo-upload').value = ''; // Reset file input
        document.getElementById('activity-photo-preview').classList.add('hidden');
        openModal('activity-photo-modal');
    }

    async function uploadActivityPhoto() {
        const activityId = document.getElementById('photo-activity-id').value;
        const fileInput = document.getElementById('activity-photo-upload');
        if (fileInput.files.length === 0) {
            return showNotification('Please select a photo to upload.', 'error');
        }
        const formData = new FormData();
        formData.append('photo', fileInput.files[0]);

        showLoading('upload-activity-photo-loading');
        try {
            const response = await apiRequest(`/api/activities/api/v1/activities/${activityId}/photo`, { method: 'POST', body: formData });
            if (response.ok) {
                showNotification('Activity photo uploaded successfully!', 'success');
                closeModal('activity-photo-modal');
                loadActivities();
            } else {
                const data = await response.json();
                showNotification(data.message || 'Failed to upload photo.', 'error');
            }
        } catch (e) {
            showNotification('Network error.', 'error');
        } finally {
            hideLoading('upload-activity-photo-loading');
        }
    }


    // Habit
    async function saveHabit() {
        const id = document.getElementById('habit-id').value;
        const isEditing = id !== '';

        const habit = {
            title: document.getElementById('modal-habit-title').value,
            start_date: document.getElementById('modal-habit-start-date').value,
            end_date: document.getElementById('modal-habit-end-date').value,
            reminder_time: document.getElementById('modal-habit-reminder-time').value
        };
        if (!habit.title || !habit.start_date || !habit.end_date) return showNotification('Please fill in all required fields', 'error');

        // CORRECTED: Route for creating habit doesn't need a trailing slash based on habit-service router
        const endpoint = isEditing ? `/api/habits/api/v1/habits/${id}` : '/api/habits/api/v1/habits';
        const method = isEditing ? 'PUT' : 'POST';

        showLoading('save-habit-loading');
        try {
            const response = await apiRequest(endpoint, { method, body: JSON.stringify(habit) });
            if (response.ok) {
                showNotification(`Habit ${isEditing ? 'updated' : 'created'}!`, 'success');
                closeModal('habit-modal');
                loadHabits();
                loadDashboard();
            } else {
                const data = await response.json();
                showNotification(data.message || 'Failed to save habit', 'error');
            }
        } catch (error) {
            showNotification('Network error. Please try again.', 'error');
        } finally {
            hideLoading('save-habit-loading');
        }
    }

    async function editHabit(id) {
        try {
            const response = await apiRequest(`/api/habits/api/v1/habits/${id}`);
            if(response.ok) {
                const data = await response.json();
                const habit = data.data;
                document.getElementById('habit-modal-title').innerText = "Edit Habit";
                document.getElementById('habit-id').value = habit.id;
                document.getElementById('modal-habit-title').value = habit.title;
                document.getElementById('modal-habit-start-date').value = new Date(habit.start_date).toISOString().split('T')[0];
                document.getElementById('modal-habit-end-date').value = new Date(habit.end_date).toISOString().split('T')[0];
                document.getElementById('modal-habit-reminder-time').value = habit.reminder_time;
                document.getElementById('save-habit-button-text').innerText = "Update Habit";
                openModal('habit-modal');
            } else {
                showNotification('Could not fetch habit details.', 'error');
            }
        } catch (error) {
            showNotification('Network error.', 'error');
        }
    }

    async function deleteHabit(id) {
        try {
            const response = await apiRequest(`/api/habits/api/v1/habits/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showNotification('Habit deleted.', 'success');
                loadHabits();
                loadDashboard();
            } else {
                showNotification('Failed to delete habit', 'error');
            }
        } catch (error) {
            showNotification('Network error.', 'error');
        }
    }

    async function logHabit(habitId) {
        const today = new Date().toISOString().split('T')[0];
        try {
            const response = await apiRequest(`/api/habits/api/v1/habits/${habitId}/logs`, {
                method: 'POST',
                body: JSON.stringify({ date: today, status: 'DONE', habit_id: habitId })
            });
            const data = await response.json();
            if (response.ok) {
                showNotification('Habit logged for today!', 'success');
                loadHabits();
            } else {
                showNotification(data.message || 'Failed to log habit', 'error');
            }
        } catch (error) {
            showNotification('Network error.', 'error');
        }
    }


    // --- UI & VIEW LOGIC ---
    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function switchAuthTab(event, tab, force = false) {
        document.querySelectorAll('#auth-tabs .tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#auth-screen .tab-content').forEach(c => c.classList.remove('active'));

        const tabButton = Array.from(document.querySelectorAll('#auth-tabs .tab')).find(t => t.textContent.toLowerCase() === tab);
        if(event) event.target.classList.add('active');
        else if (tabButton) tabButton.classList.add('active');

        document.getElementById(tab + '-form').classList.add('active');
    }

    function switchTab(event, tabName) {
        document.querySelectorAll('.card .tabs .tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.card .tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');

        if (tabName === 'statistics') loadStatistics();
    }

    function generateChart(chartData) {
        const chartContainer = document.getElementById('activity-chart');
        if (!chartData || chartData.length === 0) {
            chartContainer.innerHTML = '<p style="text-align: center; color: #888;">No chart data available. Log some activities!</p>';
            return;
        }
        const maxHours = Math.max(1, ...chartData.map(d => d.hours || 0));
        const bars = chartData.map(point => {
            const height = (point.hours / maxHours) * 180;
            return `<div class="chart-bar" style="height: ${height}px" title="${point.date}: ${point.hours.toFixed(1)} hours"></div>`;
        }).join('');
        chartContainer.innerHTML = bars;
    }

    function generateMockChart() {
        const chartContainer = document.getElementById('activity-chart');
        chartContainer.innerHTML = '<p style="text-align: center; color: #888;">Loading chart data...</p>';
    }

    function openModal(modalId) {
        if (modalId === 'activity-modal') {
            document.getElementById('activity-modal-title').innerText = "Add New Activity";
            document.getElementById('save-activity-button-text').innerText = "Create Activity";
            clearActivityForm();
        }
        if (modalId === 'habit-modal') {
            document.getElementById('habit-modal-title').innerText = "Create New Habit";
            document.getElementById('save-habit-button-text').innerText = "Create Habit";
            clearHabitForm();
        }
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

    function confirmDelete(type, id) {
        const message = `This will permanently delete the ${type}. Are you sure?`;
        const callback = type === 'activity' ? () => deleteActivity(id) : () => deleteHabit(id);
        showConfirmModal(message, callback);
    }

    function showConfirmModal(message, onConfirmCallback) {
        document.getElementById('confirm-message').textContent = message;
        const confirmButton = document.getElementById('confirm-button');

        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

        newConfirmButton.onclick = () => {
            onConfirmCallback();
            closeModal('confirm-modal');
        };
        openModal('confirm-modal');
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // --- FORM & UI HELPERS ---
    function clearActivityForm() {
        document.getElementById('activity-id').value = '';
        document.getElementById('modal-activity-title').value = '';
        document.getElementById('modal-activity-duration').value = '60';
        document.getElementById('modal-activity-cost').value = '';
        document.getElementById('modal-activity-note').value = '';
        setDefaultDates();
    }

    function clearHabitForm() {
        document.getElementById('habit-id').value = '';
        document.getElementById('modal-habit-title').value = '';
        document.getElementById('modal-habit-reminder-time').value = '09:00';
        setDefaultDates();
    }

    function setDefaultDates() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('modal-activity-start-time').value = now.toISOString().slice(0, 16);

        const today = new Date().toISOString().split('T')[0];
        const future = new Date();
        future.setDate(future.getDate() + 30);
        const futureDate = future.toISOString().split('T')[0];

        document.getElementById('modal-habit-start-date').value = today;
        document.getElementById('modal-habit-end-date').value = futureDate;
    }

    function showLoading(elementId) {
        const el = document.getElementById(elementId);
        if (el) {
            el.classList.remove('hidden');
            if(el.nextElementSibling) el.nextElementSibling.classList.add('hidden');
        }
    }

    function hideLoading(elementId) {
        const el = document.getElementById(elementId);
        if (el) {
            el.classList.add('hidden');
            if(el.nextElementSibling) el.nextElementSibling.classList.remove('hidden');
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 4000);
    }

    function previewImage(event, previewElementId) {
        const preview = document.getElementById(previewElementId);
        const file = event.target.files[0];
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    }
</script>
</body>
</html>